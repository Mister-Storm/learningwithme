name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write

jobs:
  ci:
    name: Build, Test & Coverage
    runs-on: ubuntu-latest

    steps:
      # --------------------------
      # Checkout & JDK
      # --------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      # --------------------------
      # Cache
      # --------------------------
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # --------------------------
      # Build + Tests
      # --------------------------
      - name: Build (no tests)
        run: ./gradlew build -x test --no-daemon --continue

      - name: Unit Tests
        run: ./gradlew test --no-daemon --continue

      - name: Integration Tests
        run: ./gradlew intTest --no-daemon --continue

      # --------------------------
      # PIT Mutation (allowed to fail)
      # --------------------------
      - name: Mutation Testing (PIT)
        id: pit
        run: ./gradlew pitest --no-daemon --continue
        continue-on-error: true

      # --------------------------
      # Jacoco merged + snapshots
      # --------------------------
      - name: Coverage Report
        id: jacoco
        run: ./gradlew jacocoMergedReport --no-daemon --continue
        continue-on-error: true

      # --------------------------
      # Extract Jacoco %
      # --------------------------
      - name: Extract Jacoco coverage percentage
        id: jacoco_extract
        run: |
          set -e

          REPORT="build/reports/jacoco/jacocoMergedReport/html/index.html"
          
          if [ -f "$REPORT" ]; then
            VALUE=$(grep -Po '(?<=Coverage: )\d+(\.\d+)?' "$REPORT" || echo "")
          else
            VALUE=""
          fi

          if [ -z "$VALUE" ]; then
            VALUE="n/a"
          fi

          echo "jacoco_coverage=$VALUE" >> $GITHUB_OUTPUT

      # --------------------------
      # Extract PIT %
      # --------------------------
      - name: Extract PIT mutation percentage
        id: pit_extract
        run: |
          set -e

          REPORT="build/reports/pitest/index.html"

          if [ -f "$REPORT" ]; then
            VALUE=$(grep -Po '(?<=Mutation Coverage: )\d+(\.\d+)?' "$REPORT" || echo "")
          else
            VALUE=""
          fi

          if [ -z "$VALUE" ]; then
            VALUE="n/a"
          fi

          echo "pit_coverage=$VALUE" >> $GITHUB_OUTPUT

      # --------------------------
      # Upload Artifacts
      # --------------------------
      - name: Prepare coverage artifacts
        run: |
          mkdir -p coverage/jacoco coverage/pitest

          if [ -d build/reports/jacoco/jacocoMergedReport/html ]; then
            cp -r build/reports/jacoco/jacocoMergedReport/html/* coverage/jacoco/
          fi

          if [ -d build/reports/pitest ]; then
            cp -r build/reports/pitest/* coverage/pitest/
          fi

      - name: Upload Coverage Artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: coverage

      # --------------------------
      # STICKY COMMENT NO PR
      # --------------------------
      - name: Post Coverage Comment to PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          message: |
            ## ðŸ“Š CI Coverage Summary

            **JaCoCo Coverage:** `${{ steps.jacoco_extract.outputs.jacoco_coverage }}%`  
            **PIT Mutation Coverage:** `${{ steps.pit_extract.outputs.pit_coverage }}%`

            ðŸ“Ž *Full HTML Reports:*  
            âž¤ Download via CI Artifacts (`coverage-reports`)  

