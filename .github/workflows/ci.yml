name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write

jobs:
  ci:
    name: Build, Test & Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # ------------------------------
      # BUILD + TESTS
      # ------------------------------

      - name: Build (no tests)
        run: ./gradlew build -x test --no-daemon --continue

      - name: Run Unit Tests
        run: ./gradlew test --no-daemon --continue

      - name: Run Integration Tests
        run: ./gradlew intTest --no-daemon --continue

      # ------------------------------
      # PIT (mutation testing)
      # ------------------------------

      - name: Mutation Testing (PIT)
        id: pit
        run: ./gradlew pitest --no-daemon --continue
        continue-on-error: true

      # ------------------------------
      # Jacoco merged report
      # ------------------------------

      - name: Generate Jacoco merged coverage
        id: jacoco
        run: ./gradlew jacocoMergedReport --no-daemon --continue
        continue-on-error: true

      # ------------------------------
      # Extract jacoco %
      # ------------------------------
      - name: Extract Jacoco Coverage %
        id: jacoco_extract
        run: |
          set -e
          REPORT="build/reports/jacoco/jacocoMergedReport/xml/report.xml"

          if [ -f "$REPORT" ]; then
            VALUE=$(grep -Po 'line-rate="\K[0-9\.]+' "$REPORT" | head -1)
            VALUE=$(printf "%.0f" "$(echo "$VALUE * 100" | bc -l)")
          else
            VALUE="n/a"
          fi

          echo "jacoco_coverage=$VALUE" >> $GITHUB_OUTPUT

      # ------------------------------
      # Extract PIT %
      # ------------------------------
      - name: Extract PIT Mutation %
        id: pit_extract
        run: |
          set -e
          REPORT=$(find build/reports/pitest -name "index.html" | head -1)

          if [ -n "$REPORT" ]; then
            VALUE=$(grep -Po 'Mutation Coverage[^%]*\K[0-9]+' "$REPORT" || true)
          else
            VALUE="n/a"
          fi

          echo "pit_coverage=$VALUE" >> $GITHUB_OUTPUT

      # ------------------------------
      # Prepare coverage artifacts
      # ------------------------------
      - name: Collect HTML reports
        run: |
          mkdir -p coverage/jacoco coverage/pitest

          if [ -d build/reports/jacoco/jacocoMergedReport/html ]; then
            cp -r build/reports/jacoco/jacocoMergedReport/html/* coverage/jacoco/
          fi

          PIT_DIR=$(find build/reports/pitest -type d -maxdepth 3 -mindepth 2 | head -1)
          if [ -d "$PIT_DIR" ]; then
            cp -r "$PIT_DIR"/* coverage/pitest/
          fi

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: coverage

      # ------------------------------
      # PR COMMENT
      # ------------------------------
      - name: Post Coverage Comment to PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          message: |
            ## ðŸ“Š CI Coverage Summary

            **JaCoCo Coverage:** `${{ steps.jacoco_extract.outputs.jacoco_coverage }}%`  
            **PIT Mutation Coverage:** `${{ steps.pit_extract.outputs.pit_coverage }}%`

            ðŸ“Ž **Full HTML Reports:**  
            âž¤ Download via CI Artifacts (`coverage-reports`)  

      # ------------------------------
      # SNAPSHOTS (history)
      # ------------------------------

      - name: Write JaCoCo snapshot
        run: ./gradlew writeCoverageSnapshot --no-daemon --continue

      - name: Write PIT snapshot
        run: ./gradlew writePitSnapshot --no-daemon --continue

      - name: Prepare CI History folder
        run: |
          mkdir -p ci-history
          cp .ci-history/* ci-history/ || echo "No previous history"

      - name: Upload CI History Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ci-history
          path: ci-history
