name: PR Coverage Report

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  pr-report:
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'

    runs-on: ubuntu-latest

    steps:
      - name: Download CI history artifact
        uses: actions/download-artifact@v4
        with:
          name: ci-history
          path: ./ci-history-artifact

      - name: Parse coverage & mutation results
        id: parse
        run: |
          set -e
          COVERAGE="n/a"
          MUTATION="n/a"

          echo "Listing downloaded ci-history-artifact (debug):"
          ls -R ./ci-history-artifact || echo "ci-history-artifact not found"

          SRC=$(find ./ci-history-artifact -maxdepth 2 -type d -name "ci-history" | head -1)
          if [ -n "$SRC" ] && [ -d "$SRC" ]; then
            echo "Found ci-history directory at $SRC"
            mkdir -p ./ci-history
            cp -a "$SRC"/. ./ci-history/
          else
            echo "No ci-history artifact folder found"
          fi

          echo "Listing ./ci-history (debug):"
          ls -R ./ci-history || true

          HISTORY_JSON=$(find ./ci-history/ -type f -name "history.json" | tail -1 || true)
          PIT_JSON=$(find ./ci-history/ -type f -name "pit-summary.json" | tail -1 || true)

          if [ -n "$HISTORY_JSON" ] && [ -f "$HISTORY_JSON" ]; then
            COVERAGE=$(sed -n 's/.*"coverage":\([0-9]\+\).*/\1/p' "$HISTORY_JSON" | tail -1)
          else
            echo "WARN: history.json not found in ci-history. JaCoCo coverage will be 'n/a'."
          fi

          if [ -n "$PIT_JSON" ] && [ -f "$PIT_JSON" ]; then
            MUTATION=$(sed -n 's/.*"mutationCoverage":\([0-9]\+\).*/\1/p' "$PIT_JSON" | tail -1)
          else
            echo "WARN: pit-summary.json not found in ci-history. Mutation coverage will be 'n/a'."
          fi

          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "mutation=$MUTATION" >> $GITHUB_OUTPUT

      - name: Comment coverage summary on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          message: |
            ## ðŸ“Š CI Coverage Summary
            - **JaCoCo coverage:** `${{ steps.parse.outputs.coverage }}%`
            - **PIT mutation coverage:** `${{ steps.parse.outputs.mutation }}%`
            - Artifacts disponÃ­veis no workflow:
              - `history.json`
              - `pit-summary.json`
