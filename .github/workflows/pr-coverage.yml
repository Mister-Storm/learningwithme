name: PR Coverage Report

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  pr-report:
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'

    runs-on: ubuntu-latest

    steps:
      - name: Download workflow artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Parse coverage & mutation results
        id: parse
        run: |
          COVERAGE="n/a"
          MUTATION="n/a"
          SRC=$(find ./artifacts -type d -name "ci-history" | head -1)
          if [ -n "$SRC" ] && [ -d "$SRC" ]; then
            cp -r "$SRC"/* ./ci-history/
          else
            echo "No ci-history artifact found" && ls -R ./artifacts || true
          fi
          HISTORY_JSON=$(find ./ci-history/ -type f -name "history.json" | tail -1)
          PIT_JSON=$(find ./ci-history/ -type f -name "pit-summary.json" | tail -1)

          if [ -n "$HISTORY_JSON" ] && [ -f "$HISTORY_JSON" ]; then
            COVERAGE=$(sed -n 's/.*"coverage":\([0-9]\+\).*/\1/p' "$HISTORY_JSON" | tail -1)
          fi

          if [ -n "$PIT_JSON" ] && [ -f "$PIT_JSON" ]; then
            # Expecting keys {"lineCoverage": X, "mutationCoverage": Y}
            MUTATION=$(sed -n 's/.*"mutationCoverage":\([0-9]\+\).*/\1/p' "$PIT_JSON" | tail -1)
          fi

          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "mutation=$MUTATION" >> $GITHUB_OUTPUT

      - name: Comment coverage summary on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          message: |
            ## ðŸ“Š CI Coverage Summary
            - **JaCoCo coverage:** `${{ steps.parse.outputs.coverage }}%`
            - **PIT mutation coverage:** `${{ steps.parse.outputs.mutation }}%`
            - Artifacts disponÃ­veis no workflow:
              - `history.json`
              - `pit-summary.json`
